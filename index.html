<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Chia Văn Bản Thành Nút Sao Chép - CPU LOADING</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
    :root {
        --primary-color: #4a69bd;
        --primary-light: rgba(74, 105, 189, 0.1);
        --secondary-color: #2c3e50;
        --accent-color: #e74c3c;
        --success-color: #27ae60;
        --warning-color: #e67e22;
        --light-bg: #ecf0f1;
        --card-bg: #ffffff;
        --text-dark: #2c3e50;
        --text-light: #7f8c8d;
        --border-color: rgba(0, 0, 0, 0.08);
        --box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        --border-radius: 16px;
        --transition: all 0.3s ease;
        --container-max-width: 1200px;
        --card-padding: 30px;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(145deg, #dfe6e9, #b2bec3);
        min-height: 100vh;
        padding: 40px 20px;
        color: var(--text-dark);
        line-height: 1.6;
    }

    .app-container {
        max-width: var(--container-max-width);
        margin: 0 auto;
    }

    .header {
        text-align: center;
        margin-bottom: 40px;
        padding: 20px;
        background: var(--card-bg);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
    }

    .header h1 {
        font-size: 2.5rem;
        color: var(--secondary-color);
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .header p {
        color: var(--text-light);
        font-size: 1.1rem;
        margin-top: 8px;
    }

    .card {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        margin-bottom: 30px;
        transition: var(--transition);
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
    }

    .card-header {
        background: var(--primary-color);
        color: #fff;
        padding: 15px 30px;
        font-size: 1.3rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    .card-body {
        padding: var(--card-padding);
    }

    .instructions {
        background: var(--primary-light);
        padding: 20px;
        border-radius: var(--border-radius);
        margin-bottom: 25px;
        border-left: 5px solid var(--primary-color);
    }

    .instructions h3 {
        color: var(--secondary-color);
        font-size: 1.2rem;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .instructions ol {
        padding-left: 20px;
        color: var(--text-dark);
    }

    .instructions li {
        margin-bottom: 8px;
    }

    .settings-panel {
        background: var(--light-bg);
        padding: 20px;
        border-radius: var(--border-radius);
        margin-bottom: 20px;
    }

    .setting-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
    }

    .setting-item label {
        font-weight: 500;
        color: var(--text-dark);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .word-count-control {
        display: flex;
        align-items: center;
        border: 1px solid var(--border-color);
        border-radius: 40px;
        overflow: hidden;
        background: #fff;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    .control-button {
        background: transparent;
        border: none;
        color: var(--primary-color);
        width: 40px;
        height: 40px;
        cursor: pointer;
        transition: var(--transition);
    }

    .control-button:hover {
        background: var(--primary-light);
    }

    #wordCount {
        width: 80px;
        text-align: center;
        border: none;
        padding: 10px;
        font-size: 1rem;
        font-weight: 500;
        color: var(--secondary-color);
        background: transparent;
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
        opacity: 0;
    }

    .editor-container {
        position: relative;
        margin-bottom: 20px;
    }

    #inputTextEditor, .processed-text-editor {
        width: 100%;
        padding: 15px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: 1rem;
        font-family: inherit;
        transition: var(--transition);
        margin-top: 10px;
        margin-bottom: 10px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.03);
        background: #f9f9f9;
        outline: none;
    }

    #inputTextEditor {
        height: 150px;
        background: #fff;
        overflow-y: auto;
    }

    #inputTextEditor.expanded {
        height: auto;
        overflow-y: auto;
    }

    .processed-text-editor {
        height: 100px;
        overflow-y: auto;
    }

    .processed-text-editor.expanded {
        height: auto;
    }

    #inputTextEditor:focus, .processed-text-editor:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-light);
    }

    .editor-toolbar {
        margin-bottom: 10px;
        display: flex;
        gap: 10px;
    }

    .editor-button {
        background: var(--secondary-color);
        color: #fff;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
    }

    .editor-button:hover {
        background: var(--primary-color);
    }

    .expand-button {
        background: #3c52e7;
        color: #fff;
        border: none;
        padding: 6px 12px;
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
        font-size: 0.9rem;
    }

    #expandInputButton {
        position: absolute;
        bottom: 10px;
        right: 10px;
    }

    .expand-button:hover {
        opacity: 0.9;
    }

    textarea {
        width: 100%;
        min-height: 250px;
        padding: 15px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        resize: vertical;
        font-size: 1rem;
        font-family: inherit;
        transition: var(--transition);
        margin-bottom: 20px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.03);
    }

    textarea:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-light);
        outline: none;
    }

    #promptTextarea {
        min-height: 180px;
        font-family: 'Fira Code', monospace;
        font-size: 0.95rem;
        background: #fdfdfd;
    }

    .action-button {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: #fff;
        border: none;
        padding: 12px 28px;
        font-size: 1rem;
        font-weight: 600;
        border-radius: 40px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: var(--transition);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .action-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }

    .action-button:active {
        transform: translateY(1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .copy-button {
        background: linear-gradient(135deg, var(--primary-color), #3498db);
        color: #fff;
        border: none;
        padding: 15px 20px;
        border-radius: var(--border-radius);
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        position: relative;
    }

    .copy-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }

    .copy-button:active {
        transform: translateY(1px);
    }

    .button-text {
        flex: 1;
    }

    .button-title {
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .button-range {
        font-size: 0.9rem;
        opacity: 0.85;
    }

    .copy-count {
        background: #fff;
        color: var(--secondary-color);
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .error-rate {
        font-size: 0.9rem;
        color: var(--accent-color);
        margin-top: 5px;
    }

    .double-check-result {
        font-size: 0.9rem;
        margin-top: 5px;
    }

    #splitButtons {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .stats {
        display: flex;
        justify-content: space-around;
        background: var(--light-bg);
        padding: 20px;
        border-radius: var(--border-radius);
        margin-top: 20px;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
    }

    .stat-item {
        text-align: center;
    }

    .stat-title {
        font-size: 0.9rem;
        color: var(--text-light);
    }

    .stat-value {
        font-size: 1.6rem;
        font-weight: 700;
        color: var(--secondary-color);
    }

    .reset-button {
        background: var(--accent-color);
        color: #fff;
        border: none;
        padding: 8px 16px;
        font-size: 0.9rem;
        font-weight: 500;
        border-radius: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: var(--transition);
    }

    .reset-button:hover {
        transform: translateY(-2px);
        opacity: 0.9;
    }

    .toggle-label {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
    }

    .toggle-label input[type="checkbox"] {
        appearance: none;
        width: 44px;
        height: 24px;
        background: #bdc3c7;
        border-radius: 12px;
        position: relative;
        transition: var(--transition);
    }

    .toggle-label input[type="checkbox"]:checked {
        background: var(--primary-color);
    }

    .toggle-label input[type="checkbox"]::before {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #fff;
        top: 2px;
        left: 2px;
        transition: var(--transition);
    }

    .toggle-label input[type="checkbox"]:checked::before {
        left: 22px;
    }

    .prompt-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .prompt-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--secondary-color);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .prompt-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .prompt-btn {
        background: var(--secondary-color);
        color: #fff;
        padding: 8px 16px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 500;
        transition: var(--transition);
    }

    .prompt-btn:hover {
        transform: translateY(-2px);
        opacity: 0.9;
    }

    .prompt-btn.save {
        background: var(--success-color);
    }

    .prompt-btn.export {
        background: var(--primary-color);
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--text-light);
    }

    .empty-state i {
        font-size: 3.5rem;
        color: #dcdcdc;
        margin-bottom: 15px;
    }

    .download-controls {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
    }

    .download-controls select, .download-controls input[type="checkbox"] {
        padding: 8px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    .download-controls label {
        margin-right: 10px;
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: var(--border-radius);
        color: #fff;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: var(--box-shadow);
        opacity: 0;
        transform: translateY(-20px);
        transition: var(--transition);
        z-index: 1000;
    }

    .notification.show {
        opacity: 1;
        transform: translateY(0);
    }

    .notification.success {
        background: var(--success-color);
    }

    .notification.warning {
        background: var(--warning-color);
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-4px); }
        50% { transform: translateX(4px); }
        75% { transform: translateX(-4px); }
    }

    @media (max-width: 768px) {
        .header h1 { font-size: 2rem; }
        #splitButtons { grid-template-columns: 1fr; }
        .stats { flex-direction: column; gap: 20px; }
        .prompt-header { flex-direction: column; align-items: flex-start; }
    }

    [contenteditable]:empty:before {
        content: attr(placeholder);
        color: #7f8c8d;
        pointer-events: none;
    }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1><i class="fas fa-cut"></i> Trình Chia Văn Bản</h1>
            <p>Chia nhỏ văn bản và sao chép dễ dàng với các nút tiện lợi</p>
        </header>

        <div class="card">
            <div class="card-header">
                <i class="fas fa-keyboard"></i> Nhập Văn Bản
            </div>
            <div class="card-body">
                <div class="instructions">
                    <h3><i class="fas fa-info-circle"></i> Hướng Dẫn</h3>
                    <ol>
                        <li>Nhập văn bản vào ô dưới đây, hỗ trợ in đậm, in nghiêng và in hoa.</li>
                        <li>Chọn số từ mỗi phần (mặc định: 2000).</li>
                        <li>Nhấn "Chia Văn Bản" để tạo các nút sao chép.</li>
                        <li>Nhập dữ liệu đã xử lý để kiểm tra sai sót.</li>
                    </ol>
                </div>

                <div class="settings-panel">
                    <div class="setting-item">
                        <label><i class="fas fa-text-width"></i> Số từ mỗi phần:</label>
                        <div class="word-count-control">
                            <button class="control-button" id="decreaseButton"><i class="fas fa-minus"></i></button>
                            <input type="number" id="wordCount" value="2000" min="100" max="10000" step="100">
                            <button class="control-button" id="increaseButton"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label><i class="fas fa-paste"></i> Chặn dán trùng:</label>
                        <label class="toggle-label">
                            <input type="checkbox" id="blockDuplicatePaste" checked>
                            <span>Bật</span>
                        </label>
                    </div>
                </div>

                <div class="editor-toolbar">
                    <button class="editor-button" id="boldButton"><i class="fas fa-bold"></i></button>
                    <button class="editor-button" id="italicButton"><i class="fas fa-italic"></i></button>
                    <button class="editor-button" id="uppercaseButton"><i class="fas fa-arrow-up"></i> HOA</button>
                    <button class="editor-button" id="lowercaseButton"><i class="fas fa-arrow-down"></i> thường</button>
                </div>
                <div class="editor-container">
                    <div contenteditable="true" id="inputTextEditor" placeholder="Nhập hoặc dán văn bản tại đây..."></div>
                    <button class="expand-button" id="expandInputButton">Mở rộng</button>
                </div>
                <button id="splitButton" class="action-button"><i class="fas fa-cut"></i> Chia Văn Bản</button>

                <div id="stats" class="stats" style="display: none;">
                    <div class="stat-item">
                        <div class="stat-title">Tổng số từ</div>
                        <div class="stat-value" id="totalWords">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-title">Số phần</div>
                        <div class="stat-value" id="totalButtons">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-title">Lần sao chép</div>
                        <div class="stat-value" id="totalCopies">0</div>
                    </div>
                    <button id="resetCopyCount" class="reset-button"><i class="fas fa-sync-alt"></i> Reset</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <i class="fas fa-copy"></i> Nút Sao Chép & Kiểm Tra
            </div>
            <div class="card-body">
                <div id="splitButtons">
                    <div class="empty-state">
                        <i class="fas fa-file-alt"></i>
                        <p>Chưa có nội dung. Nhập văn bản và nhấn "Chia Văn Bản" để bắt đầu.</p>
                    </div>
                </div>
                <div class="download-controls">
                    <label for="downloadOrder">Trật tự tải:</label>
                    <select id="downloadOrder">
                        <option value="asc">Theo thứ tự (1 → n)</option>
                        <option value="desc">Đảo ngược (n → 1)</option>
                    </select>
                    <label><input type="checkbox" id="selectAllParts" checked> Chọn tất cả</label>
                    <button id="downloadProcessedButton" class="action-button"><i class="fas fa-download"></i> Tải Văn Bản Đã Nhập</button>
                    <button id="doubleCheckButton" class="action-button"><i class="fas fa-check-double"></i> Double Check</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <i class="fas fa-edit"></i> Tùy Chỉnh Prompt
            </div>
            <div class="card-body">
                <div class="prompt-header">
                    <div class="prompt-title"><i class="fas fa-magic"></i> Prompt Sao Chép</div>
                    <div class="prompt-actions">
                        <label class="toggle-label">
                            <input type="checkbox" id="promptToggle" checked>
                            <span>Bật Prompt</span>
                        </label>
                        <button id="savePromptButton" class="prompt-btn save"><i class="fas fa-save"></i> Lưu</button>
                        <button id="exportPromptButton" class="prompt-btn export"><i class="fas fa-file-export"></i> Xuất</button>
                        <button id="importPromptButton" class="prompt-btn"><i class="fas fa-file-import"></i> Nhập</button>
                        <input type="file" id="promptFileInput" accept=".txt" style="display: none;">
                    </div>
                </div>
                <textarea id="promptTextarea" placeholder="Nhập prompt tùy chỉnh..."></textarea>
            </div>
        </div>
    </div>

    <div id="notification" class="notification">
        <i class="fas fa-check-circle"></i>
        <span></span>
    </div>

    <script>
    const appState = {
        defaultPrompt: `Bạn là một trợ lý AI chuyên chỉnh sửa văn bản tiếng Việt. Với đoạn văn tôi cung cấp, hãy:
1. Sửa lỗi chính tả, giữ nguyên ý nghĩa gốc.
2. Giữ mạch văn và giọng điệu tự nhiên.
3. Chia thành các đoạn nhỏ, mỗi đoạn một ý chính.
4. Định dạng:
   - Thêm tiêu đề chính và phụ nếu cần.
   - Dùng **in đậm** cho từ khóa, *nghiêng* cho điểm nhấn.
5. Không thêm nội dung mới, chỉ dùng dữ liệu có sẵn.
Đoạn văn:`,
        clickCounts: {},
        totalCopies: 0,
        wordCount: 2000,
        isPromptEnabled: true,
        lastPastedText: '', // Văn bản dán cuối cùng cho inputTextEditor
        lastPastedTextsByPart: {}, // Văn bản dán cuối cùng cho từng phần
        blockDuplicatePaste: true,
        originalChunks: [],
    };

    function initializeApp() {
        loadSavedSettings();
        document.getElementById('promptTextarea').value = appState.defaultPrompt;
        document.getElementById('wordCount').value = appState.wordCount;
        document.getElementById('blockDuplicatePaste').checked = appState.blockDuplicatePaste;
        setupEventListeners();
    }

    function loadSavedSettings() {
        const savedPrompt = localStorage.getItem('savedPrompt');
        if (savedPrompt) appState.defaultPrompt = savedPrompt;

        const promptEnabled = localStorage.getItem('promptEnabled');
        if (promptEnabled !== null) appState.isPromptEnabled = promptEnabled === 'true';

        const savedWordCount = localStorage.getItem('wordCount');
        if (savedWordCount) appState.wordCount = parseInt(savedWordCount);

        const savedStats = localStorage.getItem('textSplitterStats');
        if (savedStats) {
            const stats = JSON.parse(savedStats);
            appState.totalCopies = stats.totalCopies || 0;
        }

        const savedClickCounts = localStorage.getItem('clickCounts');
        if (savedClickCounts) appState.clickCounts = JSON.parse(savedClickCounts);

        const blockDuplicatePaste = localStorage.getItem('blockDuplicatePaste');
        if (blockDuplicatePaste !== null) appState.blockDuplicatePaste = blockDuplicatePaste === 'true';
    }

    function setupEventListeners() {
        document.getElementById('promptFileInput').addEventListener('change', importPrompt);
        document.getElementById('wordCount').addEventListener('input', updateWordCount);
        document.getElementById('decreaseButton').addEventListener('click', decreaseWordCount);
        document.getElementById('increaseButton').addEventListener('click', increaseWordCount);
        document.getElementById('splitButton').addEventListener('click', splitText);
        document.getElementById('promptToggle').addEventListener('change', togglePrompt);
        document.getElementById('savePromptButton').addEventListener('click', savePrompt);
        document.getElementById('exportPromptButton').addEventListener('click', exportPrompt);
        document.getElementById('importPromptButton').addEventListener('click', () => document.getElementById('promptFileInput').click());
        document.getElementById('inputTextEditor').addEventListener('paste', (e) => checkDuplicatePaste(e, 'main'));
        document.getElementById('blockDuplicatePaste').addEventListener('change', toggleBlockDuplicatePaste);
        document.getElementById('resetCopyCount').addEventListener('click', resetCopyCount);
        document.getElementById('downloadProcessedButton').addEventListener('click', downloadProcessedText);
        document.getElementById('doubleCheckButton').addEventListener('click', doubleCheckAll);
        
        document.getElementById('boldButton').addEventListener('click', () => document.execCommand('bold', false, null));
        document.getElementById('italicButton').addEventListener('click', () => document.execCommand('italic', false, null));
        document.getElementById('uppercaseButton').addEventListener('click', () => transformText('uppercase'));
        document.getElementById('lowercaseButton').addEventListener('click', () => transformText('lowercase'));
        
        document.getElementById('expandInputButton').addEventListener('click', () => {
            const editor = document.getElementById('inputTextEditor');
            editor.classList.toggle('expanded');
            const button = document.getElementById('expandInputButton');
            button.textContent = editor.classList.contains('expanded') ? 'Thu gọn' : 'Mở rộng';
        });

        document.getElementById('selectAllParts').addEventListener('change', toggleSelectAll);
    }

    function transformText(type) {
        const selection = window.getSelection();
        if (selection.rangeCount) {
            const range = selection.getRangeAt(0);
            const selectedText = range.toString();
            if (selectedText) {
                const newText = type === 'uppercase' ? selectedText.toUpperCase() : selectedText.toLowerCase();
                range.deleteContents();
                range.insertNode(document.createTextNode(newText));
            }
        }
    }

    function updateWordCount(e) {
        let value = parseInt(e.target.value);
        appState.wordCount = Math.min(Math.max(value, 100), 10000);
        e.target.value = appState.wordCount;
        localStorage.setItem('wordCount', appState.wordCount);
    }

    function increaseWordCount() {
        if (appState.wordCount < 10000) {
            appState.wordCount += 100;
            document.getElementById('wordCount').value = appState.wordCount;
            localStorage.setItem('wordCount', appState.wordCount);
        }
    }

    function decreaseWordCount() {
        if (appState.wordCount > 100) {
            appState.wordCount -= 100;
            document.getElementById('wordCount').value = appState.wordCount;
            localStorage.setItem('wordCount', appState.wordCount);
        }
    }

    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.querySelector('span').textContent = message;
        notification.className = `notification ${type} show`;
        if (type === 'warning') {
            notification.querySelector('i').className = 'fas fa-exclamation-triangle';
            notification.style.animation = 'shake 0.5s';
        } else {
            notification.querySelector('i').className = 'fas fa-check-circle';
            notification.style.animation = '';
        }
        setTimeout(() => notification.classList.remove('show'), 3000);
    }

    function updateStats(wordCount, buttonCount) {
        const stats = document.getElementById('stats');
        stats.style.display = 'flex';
        document.getElementById('totalWords').textContent = wordCount;
        document.getElementById('totalButtons').textContent = buttonCount;
        document.getElementById('totalCopies').textContent = appState.totalCopies;
        localStorage.setItem('textSplitterStats', JSON.stringify({ totalCopies: appState.totalCopies }));
    }

    function copyTextToClipboard(text, button, buttonId) {
        navigator.clipboard.writeText(text).then(() => {
            appState.clickCounts[buttonId] = (appState.clickCounts[buttonId] || 0) + 1;
            appState.totalCopies++;
            button.querySelector('.copy-count').textContent = appState.clickCounts[buttonId];
            button.style.transform = 'scale(0.95)';
            setTimeout(() => button.style.transform = '', 200);
            showNotification('Đã sao chép thành công!');
            localStorage.setItem('clickCounts', JSON.stringify(appState.clickCounts));
            localStorage.setItem('totalCopies', appState.totalCopies);
            updateStats(
                parseInt(document.getElementById('totalWords').textContent),
                parseInt(document.getElementById('totalButtons').textContent)
            );
        }).catch(err => {
            console.error('Sao chép thất bại:', err);
            showNotification('Sao chép thất bại!', 'warning');
        });
    }

    function normalizeText(text) {
        return text
            .replace(/\s+/g, ' ')
            .replace(/[.,!?]+$/g, '')
            .trim()
            .toLowerCase();
    }

    function calculateErrorRate(originalText, processedText) {
        const originalSentences = originalText
            .split(/[.!?]+/)
            .map(s => normalizeText(s))
            .filter(s => s.length > 0);
        
        const processedSentences = processedText
            .split(/[.!?]+/)
            .map(s => normalizeText(s))
            .filter(s => s.length > 0);

        let missingInProcessed = 0;
        let missingInOriginal = 0;

        originalSentences.forEach(originalSentence => {
            if (!processedSentences.includes(originalSentence)) {
                missingInProcessed++;
            }
        });

        processedSentences.forEach(procSentence => {
            if (!originalSentences.includes(procSentence)) {
                missingInOriginal++;
            }
        });

        const totalDifferences = missingInProcessed + missingInOriginal;
        const errorRate = originalSentences.length > 0 
            ? (totalDifferences / originalSentences.length) * 100 
            : 0;

        return errorRate.toFixed(2);
    }

    function checkDuplicateChunks(chunks) {
        const duplicates = [];
        const seen = new Set();

        chunks.forEach((chunk, index) => {
            const normalizedChunk = normalizeText(chunk);
            if (seen.has(normalizedChunk)) {
                duplicates.push(index);
            } else {
                seen.add(normalizedChunk);
            }
        });

        return duplicates;
    }

    function splitText() {
        const inputText = document.getElementById('inputTextEditor').innerText.trim();
        if (!inputText) {
            showEmptyState(document.getElementById('splitButtons'));
            document.getElementById('stats').style.display = 'none';
            return;
        }

        const words = inputText.split(/\s+/).filter(word => word);
        const buttonContainer = document.getElementById('splitButtons');
        buttonContainer.innerHTML = '';
        const wordsPerChunk = appState.wordCount;
        const chunksCount = Math.ceil(words.length / wordsPerChunk);
        appState.originalChunks = [];
        appState.lastPastedTextsByPart = {}; // Reset khi chia mới

        for (let i = 0; i < chunksCount; i++) {
            const start = i * wordsPerChunk;
            const end = Math.min((i + 1) * wordsPerChunk, words.length);
            const chunk = words.slice(start, end).join(' ');
            appState.originalChunks.push(chunk);
            createCopyButton(buttonContainer, chunk, i, start, end);
        }

        updateStats(words.length, chunksCount);
    }

    function createCopyButton(container, text, index, start, end) {
        const buttonId = `copy-button-${index}`;
        if (!appState.clickCounts[buttonId]) appState.clickCounts[buttonId] = 0;

        const buttonWrapper = document.createElement('div');
        buttonWrapper.className = 'button-wrapper';

        const button = document.createElement('button');
        button.className = 'copy-button';
        button.id = buttonId;
        button.innerHTML = `
            <div class="button-text">
                <span class="button-title"><i class="fas fa-copy"></i> Phần ${index + 1}</span>
                <span class="button-range">Từ ${start + 1} - ${end}</span>
            </div>
            <span class="copy-count">${appState.clickCounts[buttonId]}</span>
        `;

        const toolbar = document.createElement('div');
        toolbar.className = 'editor-toolbar';
        toolbar.innerHTML = `
            <button class="editor-button" onclick="document.execCommand('bold', false, null)"><i class="fas fa-bold"></i></button>
            <button class="editor-button" onclick="document.execCommand('italic', false, null)"><i class="fas fa-italic"></i></button>
            <button class="editor-button" onclick="transformText('uppercase')"><i class="fas fa-arrow-up"></i> HOA</button>
            <button class="editor-button" onclick="transformText('lowercase')"><i class="fas fa-arrow-down"></i> thường</button>
        `;

        const processedEditor = document.createElement('div');
        processedEditor.className = 'processed-text-editor';
        processedEditor.contentEditable = true;
        processedEditor.dataset.placeholder = `Nhập văn bản đã xử lý cho Phần ${index + 1}...`;

        const expandButton = document.createElement('button');
        expandButton.className = 'expand-button';
        expandButton.textContent = 'Bung';
        expandButton.addEventListener('click', () => {
            processedEditor.classList.toggle('expanded');
            expandButton.textContent = processedEditor.classList.contains('expanded') ? 'Thu gọn' : 'Bung';
        });

        const errorRateDisplay = document.createElement('div');
        errorRateDisplay.className = 'error-rate';
        errorRateDisplay.textContent = 'Tỷ lệ sai sót: 0%';

        const doubleCheckDisplay = document.createElement('div');
        doubleCheckDisplay.className = 'double-check-result';
        doubleCheckDisplay.style.fontSize = '0.9rem';
        doubleCheckDisplay.style.color = '#7f8c8d';
        doubleCheckDisplay.textContent = 'Double Check: Chưa kiểm tra';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'part-checkbox';
        checkbox.checked = true;
        checkbox.dataset.index = index;

        button.addEventListener('click', () => {
            const prompt = appState.isPromptEnabled ? document.getElementById('promptTextarea').value : '';
            const textToCopy = appState.isPromptEnabled ? `${prompt}\n\n${text}` : text;
            copyTextToClipboard(textToCopy, button, buttonId);
        });

        processedEditor.addEventListener('input', () => {
            const processedText = processedEditor.innerText.trim();
            const errorRate = calculateErrorRate(text, processedText);
            errorRateDisplay.textContent = `Tỷ lệ sai sót: ${errorRate}%`;
            doubleCheckPart(text, processedText, index, doubleCheckDisplay);
        });

        processedEditor.addEventListener('paste', (e) => checkDuplicatePaste(e, index));

        buttonWrapper.appendChild(button);
        buttonWrapper.appendChild(toolbar);
        buttonWrapper.appendChild(processedEditor);
        buttonWrapper.appendChild(expandButton);
        buttonWrapper.appendChild(errorRateDisplay);
        buttonWrapper.appendChild(doubleCheckDisplay);
        buttonWrapper.appendChild(checkbox);
        container.appendChild(buttonWrapper);
    }

    function doubleCheckPart(originalText, processedText, index, displayElement) {
        const allChunks = appState.originalChunks;
        const duplicates = checkDuplicateChunks(allChunks);

        let resultMessage = '';
        let resultColor = '#27ae60'; // Màu xanh (không lỗi)

        if (duplicates.includes(index)) {
            resultMessage = 'Trùng lặp với phần khác';
            resultColor = '#e74c3c'; // Màu đỏ (có lỗi)
        } else if (processedText) {
            const errorRate = calculateErrorRate(originalText, processedText);
            if (errorRate > 10) {
                resultMessage = 'Sai sót lớn so với gốc';
                resultColor = '#e67e22'; // Màu cam (cảnh báo)
            } else {
                resultMessage = 'Hợp lệ';
            }
        } else {
            resultMessage = 'Chưa có văn bản xử lý';
            resultColor = '#7f8c8d'; // Màu xám (chưa xử lý)
        }

        displayElement.textContent = `Double Check: ${resultMessage}`;
        displayElement.style.color = resultColor;
    }

    function doubleCheckAll() {
        const wrappers = document.querySelectorAll('.button-wrapper');
        if (wrappers.length === 0) {
            showNotification('Chưa có phần nào để kiểm tra!', 'warning');
            return;
        }

        wrappers.forEach((wrapper, index) => {
            const originalText = appState.originalChunks[index];
            const processedEditor = wrapper.querySelector('.processed-text-editor');
            const processedText = processedEditor.innerText.trim();
            const doubleCheckDisplay = wrapper.querySelector('.double-check-result');
            doubleCheckPart(originalText, processedText, index, doubleCheckDisplay);
        });

        showNotification('Đã kiểm tra tất cả các phần!');
    }

    function showEmptyState(container) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-file-alt"></i>
                <p>Chưa có nội dung. Nhập văn bản và nhấn "Chia Văn Bản" để bắt đầu.</p>
            </div>
        `;
    }

    function toggleSelectAll(e) {
        const checkboxes = document.querySelectorAll('.part-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = e.target.checked;
        });
    }

    function downloadProcessedText() {
        const editors = document.querySelectorAll('.processed-text-editor');
        const order = document.getElementById('downloadOrder').value;
        const checkboxes = document.querySelectorAll('.part-checkbox');

        if (editors.length === 0) {
            showNotification('Không có văn bản để tải!', 'warning');
            return;
        }

        const parts = Array.from(editors).map((editor, index) => ({
            index: index,
            text: editor.innerHTML.trim(),
            checked: checkboxes[index].checked
        }));

        if (order === 'desc') {
            parts.reverse();
        }

        let hasContent = false;
        let htmlContent = `
            <!DOCTYPE html>
            <html lang="vi">
            <head>
                <meta charset="UTF-8">
                <title>Văn Bản Đã Xử Lý</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.6; }
                    h2 { color: #2c3e50; margin-top: 20px; }
                    p { margin-bottom: 15px; }
                    .no-content { color: #7f8c8d; font-style: italic; }
                    b { font-weight: bold; }
                    i { font-style: italic; }
                </style>
            </head>
            <body>
                <h1>Văn Bản Đã Xử Lý</h1>
        `;

        parts.forEach(part => {
            if (part.checked) {
                hasContent = true;
                htmlContent += `<h2>Phần ${part.index + 1}</h2>`;
                if (part.text) {
                    htmlContent += `<p>${part.text}</p>`;
                } else {
                    htmlContent += `<p class="no-content">(Chưa có nội dung)</p>`;
                }
            }
        });

        htmlContent += `
            </body>
            </html>
        `;

        if (!hasContent) {
            showNotification('Không có phần nào được chọn để tải!', 'warning');
            return;
        }

        const blob = new Blob([htmlContent], { type: 'text/html' });
        saveAs(blob, `processed_text_${new Date().toISOString().slice(0, 10)}.html`);
        showNotification('Đã tải văn bản thành công!');
    }

    function togglePrompt(e) {
        appState.isPromptEnabled = e.target.checked;
        const promptTextarea = document.getElementById('promptTextarea');
        promptTextarea.disabled = !appState.isPromptEnabled;
        promptTextarea.style.opacity = appState.isPromptEnabled ? '1' : '0.5';
        localStorage.setItem('promptEnabled', appState.isPromptEnabled);
    }

    function toggleBlockDuplicatePaste(e) {
        appState.blockDuplicatePaste = e.target.checked;
        localStorage.setItem('blockDuplicatePaste', appState.blockDuplicatePaste);
        showNotification(`Đã ${appState.blockDuplicatePaste ? 'bật' : 'tắt'} chặn dán trùng!`);
    }

    function resetCopyCount() {
        appState.totalCopies = 0;
        appState.clickCounts = {};
        localStorage.setItem('totalCopies', appState.totalCopies);
        localStorage.setItem('clickCounts', JSON.stringify(appState.clickCounts));
        
        document.getElementById('totalCopies').textContent = '0';
        const buttons = document.querySelectorAll('.copy-button');
        buttons.forEach(button => {
            button.querySelector('.copy-count').textContent = '0';
        });

        showNotification('Đã reset số lần sao chép!');
    }

    function savePrompt() {
        appState.defaultPrompt = document.getElementById('promptTextarea').value;
        localStorage.setItem('savedPrompt', appState.defaultPrompt);
        showNotification('Đã lưu prompt!');
    }

    function exportPrompt() {
        const blob = new Blob([document.getElementById('promptTextarea').value], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `prompt_${new Date().toISOString().slice(0, 10)}.txt`;
        a.click();
        URL.revokeObjectURL(url);
        showNotification('Đã xuất prompt!');
    }

    function importPrompt(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            appState.defaultPrompt = event.target.result;
            document.getElementById('promptTextarea').value = appState.defaultPrompt;
            localStorage.setItem('savedPrompt', appState.defaultPrompt);
            e.target.value = '';
            showNotification('Đã nhập prompt!');
        };
        reader.readAsText(file);
    }

    function checkDuplicatePaste(e, partId) {
        const clipboardData = e.clipboardData || window.clipboardData;
        const pastedText = clipboardData.getData('text').trim();

        let lastPastedText;
        if (partId === 'main') {
            lastPastedText = appState.lastPastedText;
        } else {
            lastPastedText = appState.lastPastedTextsByPart[partId] || '';
        }

        if (appState.blockDuplicatePaste && lastPastedText === pastedText && pastedText !== '') {
            e.preventDefault();
            showNotification(`Bạn vừa dán đoạn này rồi vào ${partId === 'main' ? 'ô nhập chính' : `Phần ${partId + 1}`}, thử nội dung khác nhé!`, 'warning');
            return false;
        }

        if (partId === 'main') {
            appState.lastPastedText = pastedText;
        } else {
            appState.lastPastedTextsByPart[partId] = pastedText;
        }
        return true;
    }

    document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>